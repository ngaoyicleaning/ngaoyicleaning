<script>
    // Configuration
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxRuuxHA_Eu__aBku8hx_tGex4lJLVXyT7Io_xjiXxjxNw74u_wzREBYLon4vm55SBG/exec';
    
    let bookingData = {};
    let appliedDiscount = null;

    const addonPrices = {
        'window-cleaning': 150,
        'oven-cleaning': 180,
        'fridge-cleaning': 100,
        'laundry-service': 80,
        'carpet-cleaning': 200,
        'balcony-cleaning': 120
    };

    const addonNames = {
        'window-cleaning': 'Window Cleaning',
        'oven-cleaning': 'Oven Cleaning',
        'fridge-cleaning': 'Fridge Cleaning',
        'laundry-service': 'Laundry Service',
        'carpet-cleaning': 'Carpet Cleaning',
        'balcony-cleaning': 'Balcony Cleaning'
    };

    // Enhanced validation function
    function validateBookingData() {
        const requiredFields = ['name', 'email', 'phone', 'address', 'date', 'serviceType', 'propertySize', 'materialOption'];
        const missingFields = requiredFields.filter(field => !bookingData[field]);
        
        if (missingFields.length > 0) {
            throw new Error(`Missing required fields: ${missingFields.join(', ')}`);
        }
        
        if (!bookingData.totalAmount || bookingData.totalAmount < 2.00) {
            throw new Error('Invalid total amount. Minimum payment is R2.00');
        }
        
        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(bookingData.email)) {
            throw new Error('Please enter a valid email address');
        }
        
        // Validate phone (basic)
        const phoneRegex = /^[\d\s+\-()]{10,}$/;
        const cleanPhone = bookingData.phone.replace(/\s/g, '');
        if (!phoneRegex.test(cleanPhone) || cleanPhone.length < 10) {
            throw new Error('Please enter a valid phone number (at least 10 digits)');
        }
        
        return true;
    }

    function calculatePrice(serviceType, propertySize, date, materialOption, addons = [], recurringFrequency = null, emergencyServiceType = null, discountPercent = 0) {
        const basePrices = {
            '1-bed': { 'once-off': 350, 'recurring-weekly': 240, 'recurring-biweekly': 300, 'recurring-monthly': 360, 'deep': 1200, 'emergency': 350 },
            '2-bed': { 'once-off': 450, 'recurring-weekly': 320, 'recurring-biweekly': 400, 'recurring-monthly': 480, 'deep': 1750, 'emergency': 450 },
            '3-bed': { 'once-off': 550, 'recurring-weekly': 380, 'recurring-biweekly': 470, 'recurring-monthly': 560, 'deep': 2300, 'emergency': 550 },
            '4-bed': { 'once-off': 650, 'recurring-weekly': 440, 'recurring-biweekly': 540, 'recurring-monthly': 640, 'deep': 2800, 'emergency': 650 },
            '5+bed': { 'once-off': 800, 'recurring-weekly': 600, 'recurring-biweekly': 750, 'recurring-monthly': 900, 'deep': 3500, 'emergency': 800 },
            'office': { 'once-off': 600, 'recurring-weekly': 440, 'recurring-biweekly': 550, 'recurring-monthly': 660, 'deep': 2000, 'emergency': 600 }
        };

        let basePrice = 0;
        let emergencySurcharge = 0;
        
        if (serviceType === 'emergency' && emergencyServiceType) {
            basePrice = basePrices[propertySize]?.[emergencyServiceType] || 0;
            emergencySurcharge = Math.round(basePrice * 0.40);
        } else {
            let priceKey = serviceType;
            if (serviceType === 'recurring' && recurringFrequency) {
                priceKey = 'recurring-' + recurringFrequency.toLowerCase();
            }
            basePrice = basePrices[propertySize]?.[priceKey] || 0;
        }

        let materialsFee = 0;
        if (materialOption === 'we_supply') {
            if (serviceType !== 'deep' && !(serviceType === 'emergency' && emergencyServiceType === 'deep')) {
                materialsFee = 150;
            }
        }

        let weekendSurcharge = 0;
        if (serviceType !== 'recurring' && serviceType !== 'emergency') {
            const cleaningDate = new Date(date);
            const dayOfWeek = cleaningDate.getDay();
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                weekendSurcharge = Math.round(basePrice * 0.5);
            }
        }

        let addonsTotal = 0;
        addons.forEach(addonId => {
            addonsTotal += addonPrices[addonId] || 0;
        });

        const subtotal = basePrice + emergencySurcharge + materialsFee + weekendSurcharge + addonsTotal;
        let discountAmount = 0;
        if (discountPercent > 0 && discountPercent <= 100) {
            discountAmount = Math.round(subtotal * (discountPercent / 100));
        }
        
        const total = Math.max(0, subtotal - discountAmount);

        return {
            base: basePrice,
            materials: materialsFee,
            weekendSurcharge: weekendSurcharge,
            emergencySurcharge: emergencySurcharge,
            addons: addonsTotal,
            subtotal: subtotal,
            discountPercent: discountPercent,
            discountAmount: discountAmount,
            total: total
        };
    }

    async function applyDiscount() {
        const codeInput = document.getElementById('discount-code-input');
        const code = codeInput.value.trim().toUpperCase();
        const applyBtn = document.getElementById('apply-discount-btn');
        
        if (!code) {
            showDiscountMessage('Please enter a discount code', 'error');
            return;
        }
        
        applyBtn.disabled = true;
        applyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
        
        try {
            const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=validateDiscount&code=${encodeURIComponent(code)}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                appliedDiscount = {
                    code: result.code,
                    percentage: result.percentage
                };
                
                showDiscountMessage(`‚úì ${result.message}`, 'success');
                codeInput.disabled = true;
                applyBtn.innerHTML = '<i class="fas fa-check"></i> Applied';
                updateSummary();
            } else {
                showDiscountMessage(result.error || 'Invalid discount code', 'error');
                applyBtn.disabled = false;
                applyBtn.innerHTML = '<i class="fas fa-check"></i> Apply';
            }
        } catch (error) {
            console.error('Error applying discount:', error);
            showDiscountMessage('Failed to apply discount code. Please try again.', 'error');
            applyBtn.disabled = false;
            applyBtn.innerHTML = '<i class="fas fa-check"></i> Apply';
        }
    }

    function showDiscountMessage(message, type) {
        const messageDiv = document.getElementById('discount-message');
        messageDiv.className = `discount-message ${type}`;
        messageDiv.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            <span>${message}</span>
            ${type === 'success' ? '<button onclick="removeDiscount()"><i class="fas fa-times"></i></button>' : ''}
        `;
    }

    function removeDiscount() {
        appliedDiscount = null;
        document.getElementById('discount-code-input').value = '';
        document.getElementById('discount-code-input').disabled = false;
        document.getElementById('apply-discount-btn').disabled = false;
        document.getElementById('apply-discount-btn').innerHTML = '<i class="fas fa-check"></i> Apply';
        document.getElementById('discount-message').style.display = 'none';
        updateSummary();
    }

    function updateSummary() {
        const clientInfo = JSON.parse(localStorage.getItem('ngaoyi_booking') || '{}');
        if (!clientInfo.name) {
            window.location.href = 'index.html';
            return;
        }

        document.getElementById('summary-service').innerHTML = 
            clientInfo.serviceType ? formatServiceType(clientInfo.serviceType) : '-';
        
        if (clientInfo.serviceType === 'recurring' && clientInfo.recurringFrequency) {
            document.getElementById('summary-frequency').textContent = formatRecurringFrequency(clientInfo.recurringFrequency);
            document.getElementById('frequency-row').style.display = 'flex';
        } else {
            document.getElementById('frequency-row').style.display = 'none';
        }
        
        if (clientInfo.serviceType === 'emergency' && clientInfo.emergencyServiceType) {
            document.getElementById('summary-emergency-type').innerHTML = 
                formatServiceType(clientInfo.emergencyServiceType) + '<span class="emergency-badge">EMERGENCY</span>';
            document.getElementById('emergency-type-row').style.display = 'flex';
        } else {
            document.getElementById('emergency-type-row').style.display = 'none';
        }
        
        document.getElementById('summary-property').textContent = 
            clientInfo.propertySize ? clientInfo.propertySize.replace('-', ' ').toUpperCase() : '-';
        document.getElementById('summary-materials').textContent = 
            clientInfo.materialOption ? formatMaterialOption(clientInfo.materialOption) : '-';
        document.getElementById('summary-cleaner').textContent = 
            clientInfo.cleaner ? formatCleanerName(clientInfo.cleaner) : 'Not selected';
        document.getElementById('summary-date').textContent = 
            clientInfo.date ? new Date(clientInfo.date).toLocaleDateString('en-ZA', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            }) : '-';
        document.getElementById('summary-address').textContent = clientInfo.address || '-';

        updateAddonsSummary(clientInfo.addons || []);

        if (clientInfo.serviceType && clientInfo.propertySize && clientInfo.date && clientInfo.materialOption) {
            const discountPercent = appliedDiscount ? appliedDiscount.percentage : 0;
            
            const prices = calculatePrice(
                clientInfo.serviceType, 
                clientInfo.propertySize, 
                clientInfo.date, 
                clientInfo.materialOption,
                clientInfo.addons || [],
                clientInfo.recurringFrequency || null,
                clientInfo.emergencyServiceType || null,
                discountPercent
            );
            
            updatePriceSummary(prices, clientInfo.addons || []);
            
            clientInfo.totalAmount = prices.total;
            clientInfo.prices = prices;
            if (appliedDiscount) {
                clientInfo.discountCode = appliedDiscount.code;
                clientInfo.discountPercent = appliedDiscount.percentage;
            } else {
                delete clientInfo.discountCode;
                delete clientInfo.discountPercent;
            }
            localStorage.setItem('ngaoyi_booking', JSON.stringify(clientInfo));
            bookingData = clientInfo;
        }
    }

    function formatServiceType(serviceType) {
        const types = {
            'once-off': 'Once-off Cleaning',
            'recurring': 'Recurring Plan',
            'deep': 'Deep Cleaning',
            'commercial': 'Commercial Cleaning',
            'emergency': 'Emergency Cleaning'
        };
        return types[serviceType] || serviceType.charAt(0).toUpperCase() + serviceType.slice(1);
    }

    function formatMaterialOption(option) {
        const options = {
            'customer': 'Customer Supplies Materials',
            'we_supply': 'We Supply Materials'
        };
        return options[option] || option;
    }

    function formatCleanerName(cleaner) {
        if (cleaner === 'any') return 'Auto-Assign Best Cleaner';
        return cleaner.charAt(0).toUpperCase() + cleaner.slice(1);
    }

    function formatRecurringFrequency(frequency) {
        const frequencies = {
            'weekly': 'Weekly (Save 20%)',
            'biweekly': 'Bi-weekly (Best Value)',
            'monthly': 'Monthly'
        };
        return frequencies[frequency.toLowerCase()] || frequency;
    }

    function updateAddonsSummary(addons) {
        const container = document.getElementById('addons-summary');
        
        if (addons.length === 0) {
            container.innerHTML = '<div class="summary-item"><strong>Add-ons:</strong> <span>None selected</span></div>';
            return;
        }

        let html = '<div class="summary-item"><strong>Additional Services:</strong></div>';
        addons.forEach(addonId => {
            html += `
                <div class="addon-item">
                    <span>${addonNames[addonId]}</span>
                    <span>R${addonPrices[addonId]}</span>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function updatePriceSummary(prices, addons) {
        document.getElementById('base-price').textContent = `R${prices.base}`;
        document.getElementById('subtotal-price').textContent = `R${prices.subtotal}`;
        document.getElementById('total-price').textContent = `R${prices.total}`;
        document.getElementById('pay-amount').textContent = `R${prices.total}`;

        const materialsItem = document.getElementById('materials-item');
        if (prices.materials > 0) {
            materialsItem.style.display = 'flex';
            document.getElementById('materials-price').textContent = `R${prices.materials}`;
        } else {
            materialsItem.style.display = 'none';
        }

        const emergencyElement = document.getElementById('emergency-item');
        if (prices.emergencySurcharge > 0) {
            emergencyElement.style.display = 'flex';
            document.getElementById('emergency-price').textContent = `R${prices.emergencySurcharge}`;
        } else {
            emergencyElement.style.display = 'none';
        }

        const weekendElement = document.getElementById('weekend-item');
        if (prices.weekendSurcharge > 0) {
            weekendElement.style.display = 'flex';
            document.getElementById('weekend-price').textContent = `R${prices.weekendSurcharge}`;
        } else {
            weekendElement.style.display = 'none';
        }

        const discountElement = document.getElementById('discount-item');
        if (prices.discountAmount > 0) {
            discountElement.style.display = 'flex';
            document.getElementById('discount-percent').textContent = prices.discountPercent;
            document.getElementById('discount-amount').textContent = `-R${prices.discountAmount}`;
        } else {
            discountElement.style.display = 'none';
        }

        const addonsContainer = document.getElementById('addons-prices');
        if (addons.length > 0) {
            let addonsHtml = '';
            addons.forEach(addonId => {
                addonsHtml += `
                    <div class="price-item">
                        <span>${addonNames[addonId]}</span>
                        <span>R${addonPrices[addonId]}</span>
                    </div>
                `;
            });
            addonsContainer.innerHTML = addonsHtml;
        } else {
            addonsContainer.innerHTML = '';
        }
    }

    function generateBookingRef() {
        const timestamp = Date.now().toString().slice(-6);
        const random = Math.floor(100 + Math.random() * 900);
        return `NCL-${timestamp}${random}`;
    }

    // ENHANCED PAYMENT FUNCTION WITH COMPLETE ERROR HANDLING
    async function processPayment() {
        console.log('=== PAYMENT PROCESS STARTED ===');
        
        const payButton = document.getElementById('payButton');
        const originalButtonHTML = payButton.innerHTML;
        
        try {
            // Update booking data first
            updateSummary();
            
            // Validate everything before proceeding
            validateBookingData();
            
            console.log('‚úÖ Validation passed, creating checkout...');
            console.log('Booking Data:', bookingData);
            console.log('Total Amount:', bookingData.totalAmount);

            // Update button state
            payButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating secure checkout...';
            payButton.disabled = true;

            // Generate booking reference
            const bookingRef = bookingData.bookingRef || generateBookingRef();
            
            // Prepare checkout payload
            const checkoutPayload = {
                action: 'createCheckout',
                amount: bookingData.totalAmount,
                bookingData: {
                    bookingRef: bookingRef,
                    name: bookingData.name,
                    email: bookingData.email,
                    phone: bookingData.phone,
                    address: bookingData.address,
                    date: bookingData.date,
                    timeSlot: bookingData.timeSlot || '09:00',
                    serviceType: bookingData.serviceType,
                    propertySize: bookingData.propertySize,
                    materialOption: bookingData.materialOption,
                    cleaner: bookingData.cleaner || 'any',
                    addons: bookingData.addons || [],
                    notes: bookingData.notes || '',
                    recurringFrequency: bookingData.recurringFrequency || null,
                    emergencyServiceType: bookingData.emergencyServiceType || null,
                    discountCode: bookingData.discountCode || '',
                    discountPercent: bookingData.discountPercent || 0
                }
            };

            console.log('üì§ Sending checkout payload:', checkoutPayload);

            // Make API call with timeout and CORS mode
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout

            const response = await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(checkoutPayload),
                mode: 'cors',
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            console.log('üì• Received response, status:', response.status);
            console.log('Response OK:', response.ok);

            // Get response as text first to handle both JSON and HTML responses
            const responseText = await response.text();
            console.log('Raw response:', responseText);

            if (!response.ok) {
                throw new Error(`Server returned ${response.status}: ${response.statusText}`);
            }

            // Try to parse JSON
            let result;
            try {
                result = JSON.parse(responseText);
            } catch (parseError) {
                console.error('‚ùå JSON parse error:', parseError);
                console.error('Raw response that failed to parse:', responseText);
                throw new Error('Invalid response from server. Please check your connection and try again.');
            }

            console.log('Parsed result:', result);

            if (result.success && result.redirectUrl) {
                console.log('‚úÖ Checkout created successfully!');
                console.log('Checkout ID:', result.checkoutId);
                console.log('Redirect URL:', result.redirectUrl);
                
                // Save booking reference
                localStorage.setItem('lastBookingRef', result.bookingRef || bookingRef);
                
                // Show success message
                showPaymentMessage('‚úì Payment session created! Redirecting to secure checkout...', 'success');
                
                // Redirect after brief delay
                setTimeout(() => {
                    window.location.href = result.redirectUrl;
                }, 1000);
                
            } else {
                const errorMsg = result.error || result.message || 'Unknown error from payment gateway';
                console.error('‚ùå Checkout failed:', errorMsg);
                throw new Error(errorMsg);
            }

        } catch (error) {
            console.error('üí• PAYMENT ERROR:', error);
            
            // Restore button
            payButton.innerHTML = originalButtonHTML;
            payButton.disabled = false;
            
            // Show user-friendly error message
            let userMessage = 'Payment setup failed: ';
            
            if (error.name === 'AbortError') {
                userMessage += 'Request timed out. Please check your internet connection and try again.';
            } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                userMessage += 'Network error. Please check your internet connection.';
            } else if (error.message.includes('Missing required fields')) {
                userMessage += 'Please complete all booking details before payment.';
            } else if (error.message.includes('Invalid total amount')) {
                userMessage += 'Invalid payment amount. Please refresh the page and try again.';
            } else {
                userMessage += error.message;
            }
            
            showPaymentMessage(userMessage, 'error');
        }
    }

    function showPaymentMessage(message, type) {
        const existingMsg = document.querySelector('.payment-message');
        if (existingMsg) {
            existingMsg.remove();
        }
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `payment-message payment-message-${type}`;
        messageDiv.innerHTML = `
            <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'info' ? 'info-circle' : 'check-circle'}"></i>
            <span>${message}</span>
            <button onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
        `;
        
        const paymentSection = document.querySelector('.payment-section');
        paymentSection.insertBefore(messageDiv, paymentSection.firstChild);
        
        if (type !== 'error') {
            setTimeout(() => {
                if (messageDiv.parentElement) {
                    messageDiv.remove();
                }
            }, 10000);
        }
    }

    // Debug helper function
    async function debugPayment() {
        console.log('=== PAYMENT DEBUG INFO ===');
        console.log('Booking Data:', bookingData);
        console.log('Total Amount:', bookingData.totalAmount);
        console.log('API Endpoint:', GOOGLE_SCRIPT_URL);
        
        // Test minimal payload
        const testPayload = {
            action: 'createCheckout',
            amount: 2.00,
            bookingData: {
                bookingRef: 'TEST-' + Date.now(),
                name: 'Test Customer',
                email: 'test@example.com',
                phone: '0123456789',
                address: '123 Test St',
                date: new Date().toISOString().split('T')[0],
                timeSlot: '09:00',
                serviceType: 'once-off',
                propertySize: '2-bed',
                materialOption: 'customer',
                cleaner: 'any',
                addons: []
            }
        };
        
        try {
            const response = await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(testPayload)
            });
            
            const text = await response.text();
            console.log('Test Response:', text);
        } catch (error) {
            console.error('Test failed:', error);
        }
    }

    // Initialize on page load
    window.addEventListener('load', function() {
        console.log('=== PAYMENT PAGE LOADED ===');
        console.log('API URL:', GOOGLE_SCRIPT_URL);
        
        updateSummary();
        
        document.getElementById('discount-code-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyDiscount();
            }
        });
        
        // Test API connection
        fetch(`${GOOGLE_SCRIPT_URL}?action=test`, { mode: 'cors' })
            .then(r => console.log('API test response status:', r.status))
            .catch(e => console.log('API test failed:', e));
    });
</script>
